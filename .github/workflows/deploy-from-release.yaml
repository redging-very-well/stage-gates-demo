name: Deploy a Tag
concurrency:
  group: deploy-tag-${{ github.ref_name }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: The tag of the release to deploy.
        required: true

jobs:
  fetch-artifacts:
    runs-on: ubuntu-latest
    steps:
    - uses: robinraju/release-downloader@v1.8
      with:
        tag: ${{ inputs.release_tag }}
        fileName: dist.zip
        out-file-path: ./
        extract: false
        token: ${{ secrets.GITHUB_TOKEN }}

    # Publish our packaged artefacts for consumption by other stages:
    - uses: actions/upload-artifact@v3
      with:
        name: app
        path: ./dist.zip

  deploy-preprod:
    needs: fetch-artifacts
    uses: ./.github/workflows/wf-deploy.yaml
    with:
      artifact_name: app
      environment_name: preprod

  deploy-prod:
    needs: deploy-preprod
    uses: ./.github/workflows/wf-deploy.yaml
    with:
      artifact_name: app
      environment_name: prod
